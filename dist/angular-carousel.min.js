/**
 * Angular Carousel - Mobile friendly touch carousel for AngularJS
 * @version v0.0.8 - 2013-06-19
 * @link http://revolunet.github.com/angular-carousel
 * @author Julien Bouquillon <julien@revolunet.com>
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */
angular.module("angular-carousel",["ngMobile"]),angular.module("angular-carousel").directive("rnCarouselIndicators",[function(){return{restrict:"A",replace:!0,scope:{items:"=",index:"="},template:'<div class="rn-carousel-indicator"><span ng-repeat="item in items" ng-class="{active: $index==$parent.index}">‚óè</span></div>'}}]),angular.module("angular-carousel").directive("rnCarousel",["$compile","$parse","$swipe","CollectionManager",function(t,e,n,i){var s=0;return{restrict:"A",scope:!0,compile:function(r,o){r.addClass("rn-carousel-slides");var a=r.find("li")[0].attributes,l=a["ng-repeat"];if(l||(l=a["data-ng-repeat"]),l||(l=a["x-ng-repeat"]),!l)throw Error("carousel: cannot find the ngRepeat attribute");var c=l.value.match(/^\s*(.+)\s+in\s+(.*?)\s*(\s+track\s+by\s+(.+)\s*)?$/),u=c[1],d=c[2],h=c[3]||"",f=angular.isDefined(o.rnCarouselBuffered);return l.value=u+" in carouselCollection.cards"+h,function(r,o,a){function l(t){t.srcElement!==w[0]||"transform"!==t.propertyName&&"-webkit-transform"!==t.propertyName&&"-moz-transform"!==t.propertyName||r.$apply(function(){r.carouselCollection.adjustBuffer(),g(!0)})}function c(t,e){var n={};return n[t]=e,angular.forEach(E,function(i){n["-"+i.toLowerCase()+"-"+t]=e}),n}function u(t){return c("transform","translate3d("+t+"px,0,0)")}function h(){var t=w.find("li");return I=0===t.length?w[0].getBoundingClientRect().width:t[0].getBoundingClientRect().width,M.css("width",I+"px"),I}function g(t){t=!!t||b===!0,0===I&&h(),y=r.carouselCollection.getRelativeIndex()*-I,t===!0?w.addClass("rn-carousel-noanimate").css(u(y)):w.removeClass("rn-carousel-noanimate").addClass("rn-carousel-animate").css(u(y)),b=!1}s++;var p="rn-carousel-"+s,x=0,m=0,C=0,y=0,v=.1,I=0,b=!0,w=o.wrap("<div id='"+p+"' class='rn-carousel-container'></div>"),M=w.parent(),S=e(d),B={},$=0;if(a.rnCarouselIndex){var z=e(a.rnCarouselIndex);angular.isFunction(z.assign)?(r.$watch("carouselCollection.index",function(t){z.assign(r.$parent,t)}),r.$parent.$watch(z,function(t){r.carouselCollection.goToIndex(t,!0)})):isNaN(a.rnCarouselIndex)||($=parseInt(a.rnCarouselIndex,10))}angular.isDefined(a.rnCarouselCycle)&&(B.cycle=!0,0===$&&($=1)),B.index=$,f&&(B.bufferSize=3),r.carouselCollection=i.create(B),r.$watch("carouselCollection.updated",function(t){t&&g()}),r.$watch(S,function(t){r.carouselCollection.setItems(angular.copy(t))});var E=["webkit","moz"];if(w[0].addEventListener("webkitTransitionEnd",l,!1),w[0].addEventListener("transitionend",l,!1),angular.isDefined(a.rnCarouselIndicator)){var L=t("<div id='"+p+"-indicator' index='carouselCollection.index' items='carouselCollection.items' data-rn-carousel-indicators class='rn-carousel-indicator'></div>")(r);M.append(L)}n.bind(w,{start:function(t){0===x&&(x=1,m=t.x)},move:function(t){if(0!==x){var e=t.x-m;if(1===x&&0!==e)x=2,C=y;else if(2===x){var n=r.carouselCollection.length(),i=r.carouselCollection.index,s=1;(0===i&&t.x>m||i===n-1&&m>t.x)&&(s=3),y=C+e/s,w.css(u(y)).removeClass("rn-carousel-animate").addClass("rn-carousel-noanimate")}}},end:function(t){if(0===I&&h(),x>0){x=0;var e=r.carouselCollection.length(),n=r.carouselCollection.index,i=C>y?1:-1,s=Math.min(Math.max(0,n+i),e-1),o=t.x-m;I*v>=Math.abs(o)&&(s=n);var l=n!==s;l?r.$apply(function(){angular.isDefined(a.rnCarouselCycle)&&(r.carouselCollection.index=s,g()),r.carouselCollection.goToIndex(s,!0)}):r.$apply(function(){g()})}}})}}}}]),angular.module("angular-carousel").service("CollectionManager",[function(){function t(t){var e,n={bufferSize:0,bufferStart:0,cycle:!1,index:0,items:[],cards:[],updated:null,debug:!1},i=this;if(t)for(e in t)n[e]=t[e];for(e in n)i[e]=n[e];angular.extend(i,n,t),this.log("init",t,i,"pouet"),this.init()}return t.prototype.log=function(){this.debug&&(console.log.apply(console,arguments),console.log("CollectionManager:",this))},t.prototype.goToIndex=function(t,e){if(this.log("gotoIndex start",t,e),0===this.length())return this.log("empty, skip"),void 0;var n=!1;this.cycle&&(0===t?(this.log("cycleAtBeginning",t,this.index),this.cycleAtBeginning(),t=1,n=!0):t===this.getLastIndex()&&(this.log("cycleAtEnd",t,this.index),this.cycleAtEnd(),t-=1,n=!0)),this.index=Math.max(0,Math.min(t,this.getLastIndex())),e||this.adjustBuffer(),n||(this.updated=new Date),this.log("gotoIndex start",this.index,n)},t.prototype.next=function(){this.cycle?this.goToIndex((this.index+1)%this.length()):this.goToIndex(Math.min(this.index+1,this.getLastIndex()))},t.prototype.prev=function(){if(this.cycle)this.goToIndex((this.index-1+this.length())%this.length());else{var t=this.length()>0?Math.max(0,(this.index-1)%this.length()):0;this.goToIndex(t)}},t.prototype.setBufferSize=function(t){this.log("setBufferSize",t),this.bufferSize=t,this.adjustBuffer()},t.prototype.isBuffered=function(){return this.bufferSize>0},t.prototype.getRelativeIndex=function(){return Math.max(0,Math.min(this.getLastIndex(),this.index-this.bufferStart))},t.prototype.adjustBuffer=function(){var t=this.getLastIndex()+1-this.bufferSize;this.bufferStart=Math.max(0,Math.min(t,this.index-1)),this.cards=this.items.slice(this.bufferStart,this.bufferStart+this.bufferSize),this.log("adjustBuffer",this.bufferStart,this.cards)},t.prototype.length=function(){return this.items.length},t.prototype.getLastIndex=function(){return Math.max(0,this.length()-1)},t.prototype.init=function(){this.log("init"),this.setBufferSize(this.bufferSize||this.length()),this.goToIndex(this.index)},t.prototype.setItems=function(t){this.log("setItems",t),this.items=t,this.init()},t.prototype.cycleAtEnd=function(){this.push(this.items.shift())},t.prototype.push=function(t){this.items.push(t)},t.prototype.unshift=function(t){this.items.unshift(t)},t.prototype.cycleAtBeginning=function(){this.unshift(this.items.pop())},{create:function(e){return new t(e)}}}]);